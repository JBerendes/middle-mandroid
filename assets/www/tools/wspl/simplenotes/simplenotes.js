/*
  Copyright 2009 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
*/
/**
 * @fileoverview A concrete example of the cache pattern for building an offline
 * webapplication: a cache for SimpleNotes.
 */
google.wspl.simplenotes=google.wspl.simplenotes||{},google.logger("start simplenotes.js"),google.wspl.simplenotes.WriteBufferStates={INFLIGHT:1,SEND:2,REAPPLY:8},google.wspl.simplenotes.Cache=function(){this.dbms_=google.wspl.DatabaseFactory.createDatabase("simple-notes","http://yourdomain/dbworker.js"),this.start_=-1,this.end_=-1,this.serverStart_=-1,this.serverEnd_=-1,this.lastRefresh_=-1,this.lastMiss_=undefined},google.wspl.simplenotes.Cache.TIME_BETWEEN_REFRESH_=2e3,google.wspl.simplenotes.Cache.CREATE_CACHED_NOTES_=new google.wspl.Statement("CREATE TABLE IF NOT EXISTS cached_notes (noteKey INTEGER UNIQUE PRIMARY KEY,subject TEXT,body TEXT);"),google.wspl.simplenotes.Cache.CREATE_WRITE_BUFFER_=new google.wspl.Statement("CREATE TABLE IF NOT EXISTS write_buffer (sequence INTEGER UNIQUE PRIMARY KEY AUTOINCREMENT,noteKey INTEGER,status INTEGER,subject TEXT,body TEXT);"),google.wspl.simplenotes.Cache.DETERMINE_MIN_KEY_=new google.wspl.Statement("SELECT MIN(noteKey) as minNoteKey FROM cached_notes;"),google.wspl.simplenotes.Cache.DETERMINE_MAX_KEY_=new google.wspl.Statement("SELECT MAX(noteKey) as maxNoteKey FROM cached_notes;"),google.wspl.simplenotes.Cache.prototype.startCache=function(e){google.logger("startCache");var t=0,n=this,r=function(e,r){google.logger("perStatCallback"),t==4?(n.start_=r.isValidRow()?r.getRow().minNoteKey:-1,n.serverStart_=n.start_):t==5&&(n.end_=r.isValidRow()?r.getRow().maxNoteKey:-1,n.serverEnd_=n.end_),t++};this.dbms_.executeAll([google.wspl.simplenotes.Cache.CREATE_CACHED_NOTES_,google.wspl.simplenotes.Cache.CREATE_WRITE_BUFFER_,google.wspl.simplenotes.Cache.CREATE_UPDATE_TRIGGER_,google.wspl.simplenotes.Cache.CREATE_REPLAY_TRIGGER_,google.wspl.simplenotes.Cache.DETERMINE_MIN_KEY_,google.wspl.simplenotes.Cache.DETERMINE_MAX_KEY_],{onSuccess:r,onFailure:this.logError_},{onSuccess:e,onFailure:this.logError_}),google.logger("finished startCache")},google.wspl.simplenotes.Cache.prototype.sendXhrPost=function(e){google.logger("Should dispatch XHR to server now.")},google.wspl.simplenotes.Cache.LIST_CACHED_NOTES_=new google.wspl.Statement("SELECT noteKey, subject from cached_notes WHERE noteKey >= ? AND noteKey <= ? ;"),google.wspl.simplenotes.Cache.prototype.isCacheHit_=function(e,t){return e>=this.start_&&t<=this.end_},google.wspl.simplenotes.Cache.prototype.logError_=function(e){google.logger("Simple Notes Cache is sad: "+e)},google.wspl.simplenotes.Cache.prototype.getNoteList_=function(e,t,n){var r=[],i=function(e,t){for(;t.isValidRow();t.next())r.push(t.getRow()),google.logger("pushed...")},s=function(n){n.execute(google.wspl.simplenotes.Cache.LIST_CACHED_NOTES_.createStatement([e,t]),{onSuccess:i,onFailure:this.logError_})},o=this.isCacheHit_(e,t);this.dbms_.createTransaction(s,{onSuccess:function(){n(r,o)},onFailure:this.logError_}),o?this.fetchFromServer(this.start_,this.end_):(this.fetchFromServer(Math.min(this.start_,e),Math.max(this.end_,t)),this.lastMiss_={callback:n,start:e,end:t})},google.wspl.simplenotes.Cache.GET_ONE_NOTE_=new google.wspl.Statement("SELECT noteKey, subject, body from cached_notes WHERE noteKey = ? ;"),google.wspl.simplenotes.Cache.prototype.getOneNote_=function(e,t){var n;this.dbms_.execute(google.wspl.simplenotes.Cache.GET_ONE_NOTE_.createStatement([e]),{onSuccess:function(e,t){n=t.getRow()},onFailure:this.logError_},{onSuccess:function(){t(n,!0)},onFailure:this.logError_})},google.wspl.simplenotes.Cache.prototype.getValues=function(e,t,n){t[0]=Math.max(this.serverStart_,t[0]),t[1]=Math.min(this.serverEnd_,t[1]),e=="list"?this.getNoteList_(t[0],t[1],n):e=="fullnote"&&this.getOneNote_(t[0],n)},google.wspl.simplenotes.Cache.CREATE_UPDATE_TRIGGER_=new google.wspl.Statement("CREATE TRIGGER IF NOT EXISTS updateTrigger AFTER INSERT ON write_buffer BEGIN   REPLACE INTO cached_notes     SELECT noteKey, subject, body       FROM write_buffer WHERE status & 8 = 8;   UPDATE write_buffer SET status = status & ~ 8; END;"),google.wspl.simplenotes.Cache.CREATE_REPLAY_TRIGGER_=new google.wspl.Statement("CREATE TRIGGER IF NOT EXISTS replayTrigger AFTER UPDATE ON write_buffer WHEN NEW.status & 8 = 8 BEGIN   REPLACE INTO cached_notes     SELECT noteKey, subject, body       FROM write_buffer       WHERE noteKey = NEW.noteKey       ORDER BY sequence ASC;  UPDATE write_buffer SET status = status & ~ 8; END;"),google.wspl.simplenotes.Cache.MARK_FOR_REPLAY=new google.wspl.Statement("UPDATE write_buffer SET status = status | 8;"),google.wspl.simplenotes.Cache.INSERT_UI_UPDATE_=new google.wspl.Statement("INSERT INTO write_buffer (noteKey, status, subject, body) VALUES(?,?,?,?);"),google.wspl.simplenotes.Cache.prototype.applyUiChange=function(e,t,n,r){var i=this,s=[e,10,t,n],o=google.wspl.simplenotes.Cache.INSERT_UI_UPDATE_.createStatement(s);this.dbms_.execute(o,null,{onSuccess:function(){google.logger("applyUiChange cb"),r(e)},onFailure:function(e){i.logError_(e),r(-1)}})},google.wspl.simplenotes.Cache.INSERT_NOTE_=new google.wspl.Statement("REPLACE INTO cached_notes (noteKey, subject, body) VALUES(?,?,?);"),google.wspl.simplenotes.Cache.FORCE_REPLAY_=new google.wspl.Statement("UPDATE write_buffer SET status = status | 8;"),google.wspl.simplenotes.Cache.EVICT_=new google.wspl.Statement("DELETE FROM cached_notes WHERE noteKey < ? OR noteKey > ?;"),google.wspl.simplenotes.Cache.prototype.insertUpdate=function(e){var t=this,n=[],r=e[0].noteKey,i=e[0].noteKey;for(var s=0;s<e.length;s++)n.push(google.wspl.simplenotes.Cache.INSERT_NOTE_.createStatement([e[s].noteKey,e[s].subject,e[s].body])),r=Math.min(r,e[0].noteKey),i=Math.max(i,e[0].noteKey);n.push(google.wspl.simplenotes.Cache.EVICT_.createStatement([r,i])),n.push(google.wspl.simplenotes.Cache.FORCE_REPLAY_);var o=function(e){t.start_=r,t.end_=i,e.executeAll(n)},u=function(t){this.lastMiss_&&this.isCacheHit_(this.lastMiss_.start,this.lastMiss_.end)&&(this.lastMiss_.callback(e),this.lastMiss_=undefined)};this.dbms_.createTransaction(o,{onSuccess:u,onError:this.logError_})},google.wspl.simplenotes.Cache.GET_UPDATES_TO_RESEND_=new google.wspl.Statement("SELECT noteKey, subject, body FROM write_buffer WHERE status & 2 = 2;"),google.wspl.simplenotes.Cache.MARK_AS_INFLIGHT_=new google.wspl.Statement("UPDATE write_buffer SET status = status & ~2 | 1 WHERE status & 2 = 2;"),google.wspl.simplenotes.Cache.prototype.fetchFromServer=function(e,t){google.logger("fetchFromServer");var n=this.dbms_.getCurrentTime();if(e>=this.start_&&t<=this.end_&&n-this.lastRefresh_<google.wspl.simplenotes.Cache.TIME_BETWEEN_REFRESH_)return;var r=[],i=this,s=1,o=[];o.push(google.wspl.simplenotes.Cache.GET_UPDATES_TO_RESEND_),o.push(google.wspl.simplenotes.Cache.MARK_AS_INFLIGHT_);var u=function(e,t){if(s==1){for(;t.isValidRow();t.next())r.push(["u",t.getRow()]);s++}},a=function(){r.push(["q",{start:e,end:t}]),i.sendXhrPost(r)};this.dbms_.executeAll(o,{onSuccess:u,onFailure:this.logError_},{onSuccess:a,onFailure:this.logError_})};